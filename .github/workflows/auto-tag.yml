name: Auto Tag on Version Bump

on:
  push:
    branches: [ "master" ]
    paths:
      - 'BTCPayServer.Plugins.ArkPayServer/BTCPayServer.Plugins.ArkPayServer.csproj'

jobs:
  build-and-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 2  # Need at least 2 commits to compare
        
    - name: Extract version from csproj
      id: version
      run: |
        VERSION=$(grep -oP '<Version>\K[^<]+' BTCPayServer.Plugins.ArkPayServer/BTCPayServer.Plugins.ArkPayServer.csproj)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Detected version: $VERSION"
        
    - name: Check if tag exists
      id: tag_check
      run: |
        if git rev-parse "v${{ steps.version.outputs.version }}" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "Tag v${{ steps.version.outputs.version }} already exists"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "Tag v${{ steps.version.outputs.version }} does not exist"
        fi
    
    - name: Trigger BTCPay Plugin Builder
      id: build
      if: steps.tag_check.outputs.exists == 'false'
      env:
        BTCPAY_EMAIL: ${{ secrets.BTCPAY_BUILDER_EMAIL }}
        BTCPAY_PASSWORD: ${{ secrets.BTCPAY_BUILDER_PASSWORD }}
      run: |
        # Create build request
        BUILD_RESPONSE=$(curl -s --user "$BTCPAY_EMAIL:$BTCPAY_PASSWORD" \
          -X POST \
          -H "Content-Type: application/json" \
          -d "{\"gitRepository\": \"https://github.com/${{ github.repository }}\", \"gitRef\": \"${{ github.sha }}\", \"pluginDirectory\": \"BTCPayServer.Plugins.ArkPayServer\", \"buildConfig\": \"Release\"}" \
          "https://plugin-builder.btcpayserver.org/api/v1/plugins/arkade/builds")
        
        echo "Build response: $BUILD_RESPONSE"
        
        # Extract build ID
        BUILD_ID=$(echo $BUILD_RESPONSE | jq -r '.buildId')
        BUILD_URL=$(echo $BUILD_RESPONSE | jq -r '.buildUrl')
        
        if [ "$BUILD_ID" == "null" ] || [ -z "$BUILD_ID" ]; then
          echo "‚ùå Failed to create build"
          echo "$BUILD_RESPONSE"
          exit 1
        fi
        
        echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
        echo "build_url=$BUILD_URL" >> $GITHUB_OUTPUT
        echo "‚úÖ Build created: $BUILD_URL"
        
    - name: Wait for build completion
      if: steps.tag_check.outputs.exists == 'false'
      env:
        BTCPAY_EMAIL: ${{ secrets.BTCPAY_BUILDER_EMAIL }}
        BTCPAY_PASSWORD: ${{ secrets.BTCPAY_BUILDER_PASSWORD }}
      run: |
        BUILD_ID="${{ steps.build.outputs.build_id }}"
        MAX_WAIT=600  # 10 minutes
        ELAPSED=0
        
        echo "Waiting for build $BUILD_ID to complete..."
        
        while [ $ELAPSED -lt $MAX_WAIT ]; do
          BUILD_STATUS=$(curl -s --user "$BTCPAY_EMAIL:$BTCPAY_PASSWORD" \
            "https://plugin-builder.btcpayserver.org/api/v1/plugins/arkade/builds/$BUILD_ID")
          
          ERROR=$(echo $BUILD_STATUS | jq -r '.buildInfo.error')
          DOWNLOAD_LINK=$(echo $BUILD_STATUS | jq -r '.downloadLink')
          
          if [ "$ERROR" != "null" ] && [ "$ERROR" != "" ]; then
            echo "‚ùå Build failed with error: $ERROR"
            exit 1
          fi
          
          if [ "$DOWNLOAD_LINK" != "null" ] && [ "$DOWNLOAD_LINK" != "" ]; then
            echo "‚úÖ Build completed successfully!"
            echo "Download: $DOWNLOAD_LINK"
            break
          fi
          
          echo "Build still in progress... (${ELAPSED}s elapsed)"
          sleep 10
          ELAPSED=$((ELAPSED + 10))
        done
        
        if [ $ELAPSED -ge $MAX_WAIT ]; then
          echo "‚ùå Build timed out after ${MAX_WAIT}s"
          exit 1
        fi
        
    - name: Create and push tag
      if: steps.tag_check.outputs.exists == 'false'
      run: |
        git tag "v${{ steps.version.outputs.version }}"
        git push origin "v${{ steps.version.outputs.version }}"
        echo "‚úÖ Created and pushed tag v${{ steps.version.outputs.version }}"
        echo "üîó Build URL: ${{ steps.build.outputs.build_url }}"
